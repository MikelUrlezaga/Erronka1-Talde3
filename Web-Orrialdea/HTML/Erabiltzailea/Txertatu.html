<!DOCTYPE html>
    <head>
        <meta charset="UTF-8">
        <script src="../../script/aldagaiGlobalak.js" ></script>
        <script src="../../script/menu.js" ></script>
        <link rel="stylesheet" href="../../CSS/styles.css">
        <link rel="icon" href="../../IMG/LOGO.png" type="image/x-icon">
        <title>Erabiltzailea Txertatu</title>
    </head>
    <header>
            <img class="logo" src="../../IMG/LOGO.png">
            <p class="titulo">ERABILTZAILEA TXERTATU</p>
            <div class="headerdiv">
                <a href="Taula.html">
                    <img class="headerimg" src="../../IMG/arrow.png">
                </a>
                <p>&nbsp;</p>
                <a href="../../HTML/Orokorra/Login.html">
                    <img class="headerimg" src="../../IMG/LogOut.png">
                </a>
            </div>
    </header>
    <body onkeydown="teclado(event)">
        <div class="reborde">
                <br><br><br><br>
                <div class="dobleColumn">
                    <div>
                        <p class="texto">NAN: </p>
                        <input class="textBox" type="text" id="nanErabiltzaileaTxertatu" name="NAN" >
                    </div>
                    <div>
                        <p class="texto">Izena: </p>
                        <input class="textBox" type="text" id="izenaErabiltzaileaTxertatu" name="Izena">
                    </div>
                    <div>
                        <p class="texto">Abizena: </p>
                        <input class="textBox" type="text" id="abizenaErabiltzaileaTxertatu" name="Abizena">
                    </div>
                    <div>
                        <p class="texto">Erabiltzailea: </p>
                        <input class="textBox" type="text" id="erabiltzaileaErabiltzaileaTxertatu" name="Erabiltzailea">
                    </div>
                    <div>
                        <p class="texto">Pasahitza: </p>
                        <input class="textBox" type="password" id="pasahitzaEraEgu" name="Pasahitza">
                        <img class="ojo" id="ojo" src="../../IMG/ojo2.png" onclick="vernover()">
    
                    </div>
                    <div>
                        <p class="texto">Admin: </p>
                        <input class="textBox" type="checkbox" id="rolaEraEgu" name="Rola" onchange="leerRol()">
                    </div>
                    <div class="ck">
                        <img src="../../IMG/unnamed.png" alt="check" class="checkicon" onclick="createErabiltzailea()">
                    </div>
                </div>
        </div>
    </body>
    <div id="menuMugikorra"></div>
</html>
<script>

    function teclado(event) {
        var codigo = event.which || event.keyCode;
        if (codigo==13) {
            createErabiltzailea()
        }
    }
    
    function validateDNI(dni) {
        var numero, let, letra;
        var expresion_regular_dni = /^[XYZ]?\d{5,8}[A-Z]$/;

        dni = dni.toUpperCase();

        if(expresion_regular_dni.test(dni) === true){
            numero = dni.substr(0,dni.length-1);
            numero = numero.replace('X', 0);
            numero = numero.replace('Y', 1);
            numero = numero.replace('Z', 2);
            let = dni.substr(dni.length-1, 1);
            numero = numero % 23;
            letra = 'TRWAGMYFPDXBNJZSQVHLCKET';
            letra = letra.substring(numero, numero+1);
            if (letra != let) {
                //alert('Dni erroneo, la letra del NIF no se corresponde');
                return false;
            }else{
                //alert('Dni correcto');
                return true;
            }
        }else{
            //alert('Dni erroneo, formato no vÃ¡lido');
            return false;
        }
    }

     function nanOndo(nan) {
         let dni = nan;
         let error = false;

         function devuelveletra(nums) {
             const letras = "TRWAGMYFPDXBNJZSQVHLCKE";
             const resto = nums % 23;
             return letras.charAt(resto);
         }

         dni = dni.toUpperCase();
         const lon = dni.replace(/ /g, "").length;

         if (lon !== 9 && lon !== 8) {
             console.log("Longitud del DNI incorrecta");
             error = true;
         }

         if (lon === 8) {
             const letra2 = devuelveletra(parseInt(dni.substring(0, 8), 10));
             dni = dni.substring(0, 8) + letra2;
             return dni;
         } else {
             if (lon === 9) {
                 if (!isNaN(dni.substring(0, 8)) && dni.charAt(8) === devuelveletra(parseInt(dni.substring(0, 8), 10))) {
                 return dni;
                 } else {
                     error = true;
                 }
             }
         }

         if (error) {
             return "Mal";
         }
     }

    // Ejemplo de uso:
    // const resultado = nanOndo("12345678A");
    // console.log(resultado);

    function createErabiltzailea() {
        var nan = nanOndo(document.getElementById("nanErabiltzaileaTxertatu").value);
        if(nan=="Mal"){

        }else{
 //var nancorrecto= validateDNI(nan);
 var izena = document.getElementById("izenaErabiltzaileaTxertatu").value;
        var abizena = document.getElementById("abizenaErabiltzaileaTxertatu").value;
        var erabiltzailea = document.getElementById("erabiltzaileaErabiltzaileaTxertatu").value;
        var pasahitza = document.getElementById("pasahitzaEraEgu").value;
        var rola =  leerRol();
        var clasea = {nan, izena, abizena, erabiltzailea, pasahitza, rola};
        var js = JSON.stringify(clasea);
        console.log(js);
        // if(nancorrecto==true){
            fetch(rutaBack + 'erabiltzailea_json.php', {method: 'POST', body: js})
            .then(function (response) {
                    return response.text();
                    alert("Se ha insertado")
            })
            .then(data=>{
                console.log(data);
                
            })
        }
       
        // }else{
        //     alert("El DNI esta mal")
        // }
        
            // .catch(error => {
            //     //console.log("Erregistro hau beste taula batean erabiltzen ari da, beraz, ezin da ezabatu" + error);
            // });
}

function vernover() {
            if ((document.getElementById("ojo").src).includes("ojo1")) {
                document.getElementById("ojo").src = "../../IMG/ojo2.png"
                document.getElementById("pasahitzaEraEgu").type = "password"
            } else {
                document.getElementById("ojo").src = "../../IMG/ojo1.png"
                document.getElementById("pasahitzaEraEgu").type = "text"
            }
            
        }

        function leerRol(){
            if( document.getElementById("rolaEraEgu").checked){
                console.log("Check");
                return "A"; 
            }else{
                console.log("No")
                return "B";
            }
               
        }
</script>