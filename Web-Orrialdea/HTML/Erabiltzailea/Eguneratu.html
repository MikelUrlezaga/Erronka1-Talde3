<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="../../script/aldagaiGlobalak.js" ></script>
        <script src="../../script/menu.js"></script>
        <link rel="stylesheet" href="../../CSS/styles.css">
        <link rel="icon" href="../../IMG/LOGO.png" type="image/x-icon">
        <title>Erabiltzailea Eguneratu</title>
    </head>
    <body onkeydown="teclado(event)">
        <header>
            <img class="logo" src="../../IMG/LOGO.png" alt="Logo">
            <p class="titulo">ERABILTZAILEA EGUNERATU</p>
            <div class="headerdiv">
                <a href="Taula.html">
                    <img class="headerimg" src="../../IMG/arrow.png">
                </a>
                <p>&nbsp;</p>
                <a href="../../HTML/Orokorra/Login.html">
                    <img class="headerimg" src="../../IMG/LogOut.png" alt="Logout">
                </a>
            </div>
        </header>
        <div class="reborde">
            <select id="selectore" onchange="aldatuErabiltzaile()">
                <!-- Opciones se cargarán dinámicamente -->
            </select>
            <div class="dobleColumn">
                <div>
                    <p class="texto">NAN: </p>
                    <input class="textBox" type="text" id="nanEraEgu" name="NAN">
                </div>
                <div>
                    <p class="texto">Izena: </p>
                    <input class="textBox" type="text" id="izenaEraEgu" name="Izena">
                </div>
                <div>
                    <p class="texto">Abizena: </p>
                    <input class="textBox" type="text" id="abizenaEraEgu" name="Abizena">
                </div>
                <div>
                    <p class="texto">Erabiltzailea: </p>
                    <input class="textBox" type="text" id="erabiltzaileaEraEgu" name="Erabiltzailea">
                </div>
                <div>
                    <p class="texto">Pasahitza: </p>
                    <input class="textBox" type="password" id="pasahitzaEraEgu" name="Pasahitza">
                    <img class="ojo" id="ojo" src="../../IMG/ojo2.png" onclick="vernover()">

                </div>
                <div>
                    <p class="texto">Admin: </p>
                    <input class="textBox" type="checkbox" id="rolaEraEgu" name="Rola">
                </div>
            </div>
            <div class="ck">
                <img src="../../IMG/unnamed.png" alt="check" class="checkicon" onclick="actuErabiltzailea()">
            </div>
    </body>
    <div id="menuMugikorra"></div>
    <script>

        function teclado(event) {
            var codigo = event.which || event.keyCode;
            if (codigo==13) {
                actuErabiltzailea()
            }
        }

        var paramstr = window.location.search.substr(1);
        var paramarr = paramstr.split("&");
        var params = {};
        var gureNan = 0;

        for (var i = 0; i < paramarr.length; i++) {
            var tmparr = paramarr[i].split("=");
            params[tmparr[0]] = tmparr[1];
            gureNan = tmparr[1];
        }

        function aldatuErabiltzaile() {
            var NanUsuario = document.getElementById("selectore").value;
            gureNan = NanUsuario;
            cargarDatosUsuario(gureNan);
        }

        window.addEventListener("load", cargarOpcionesSelectUsuarios);
        window.addEventListener("load", cargarDatosUsuario(gureNan));


        async function cargarOpcionesSelectUsuarios() {
        let options = {method: "GET"};
        fetch(rutaBack + "erabiltzailea_json.php", options)
            .then(response => response.json())  // Analiza la respuesta JSON
            .then(data => {
                console.log(data);
                for (let i = 0; i < data.length; i++) {
                    console.log(gureNan);
                    if(data[i].nan==gureNan){
                        console.log("Entra "+gureNan);
                    }
                    var opcion="<option value='"+data[i].nan+"'>"+data[i].izena+"</option>";
                    var opElement = document.createElement("option");
                    opElement.innerHTML = opcion;
                    opElement.value = data[i].nan;
                    if(data[i].nan==gureNan){
                        opElement.selected="selected";
                    }
                    
                    document.getElementById("selectore").appendChild(opElement);
                }
            })
            .catch(error => {
                alert("Errorea." + error);
            });
        }

        function cargarDatosUsuario(gureNan) {
            console.log("Ha entrado")
            let options = {method: "GET"};
            fetch(rutaBack + "erabiltzailea_json.php?num="+gureNan+"", options)
                .then(response => response.json())  // Analiza la respuesta JSON
                .then(data => {
                    console.log(data + " jhhhjh");
                    console.log(data.length);
                    document.getElementById("nanEraEgu").value=data[0].nan;
                    document.getElementById("izenaEraEgu").value=data[0].izena;
                    document.getElementById("abizenaEraEgu").value=data[0].abizena;
                    document.getElementById("erabiltzaileaEraEgu").value=data[0].erabiltzailea;
                    document.getElementById("pasahitzaEraEgu").value=data[0].pasahitza;
                    if (data[0].rola == "A") {
                        document.getElementById("rolaEraEgu").checked = true
                    }else{
                        document.getElementById("rolaEraEgu").checked = false
                    }
                    document.getElementById("selectore").value=gureNan;
                    //document.getElementsByClassName("titulo").innerHTML= data[0].izena + " Erabiltzailea eguneratu";
                })
                .catch(error => {
                    alert("Errorea." + error);
                });

        }


        function actuErabiltzailea() {
            var nan = document.getElementById("selectore").value;
            var izena = document.getElementById("izenaEraEgu").value;
            var abizena = document.getElementById("abizenaEraEgu").value;
            var erabiltzailea = document.getElementById("erabiltzaileaEraEgu").value;
            var pasahitza = document.getElementById("pasahitzaEraEgu").value;
            if (document.getElementById("rolaEraEgu").checked) {
                var rola = "A";
            } else {
                var rola = "B";
            }
            var erabil = { nan, izena, abizena, erabiltzailea, pasahitza, rola };
            var js = JSON.stringify(erabil);
            fetch(rutaBack + 'erabiltzailea_json.php', { method: 'PUT', body: js })
                .then(function (response) {
                    return response.text();
                })
                .then(data => {
                    console.log(data);
                });
        }

        function vernover() {
            if ((document.getElementById("ojo").src).includes("ojo1")) {
                document.getElementById("ojo").src = "../../IMG/ojo2.png"
                document.getElementById("pasahitzaEraEgu").type = "password"
            } else {
                document.getElementById("ojo").src = "../../IMG/ojo1.png"
                document.getElementById("pasahitzaEraEgu").type = "text"
            }
            
        }
    
    </script>
</html>
